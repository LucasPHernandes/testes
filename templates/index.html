{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-speedometer2"></i> Inicio</h2>
        <hr>
    </div>
</div>

<!-- Cards de Estatísticas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Total Alunos</h6>
                        <h2 class="mb-0" id="stat-total-alunos">0</h2>
                    </div>
                    <i class="bi bi-people-fill" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Bloqueados</h6>
                        <h2 class="mb-0" id="stat-bloqueados">0</h2>
                    </div>
                    <i class="bi bi-lock-fill" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Em Risco</h6>
                        <h2 class="mb-0" id="stat-em-risco">0</h2>
                    </div>
                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Total Débitos</h6>
                        <h2 class="mb-0" id="stat-debitos">R$ 0,00</h2>
                    </div>
                    <i class="bi bi-cash-stack" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ações Rápidas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning-charge-fill"></i> Ações Rápidas</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100 py-3" onclick="window.location.href='/alunos'">
                            <i class="bi bi-people-fill fs-4 d-block mb-2"></i>
                            <span class="fw-bold">Gerenciar Alunos</span>
                            <br><small class="opacity-75">Ver lista e histórico</small>
                        </button>
                    </div>
                    
                    <div class="col-md-4">
                        <button class="btn btn-success w-100 py-3" onclick="abrirModalImportar()">
                            <i class="bi bi-file-earmark-spreadsheet fs-4 d-block mb-2"></i>
                            <span class="fw-bold">Importar Arquivo</span>
                            <br><small class="opacity-75">(.xls ou .xlsx)</small>
                        </button>
                    </div>
                    
                    <div class="col-md-4">
                        <button class="btn btn-info w-100 py-3" onclick="window.location.href='/relatorios'">
                            <i class="bi bi-file-text-fill fs-4 d-block mb-2"></i>
                            <span class="fw-bold">Gerar Relatórios</span>
                            <br><small class="opacity-75">Análises e estatísticas</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Importação Único -->
<div class="modal fade" id="modalImportar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-earmark-excel"></i> Importar Arquivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formImportar" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="arquivo" class="form-label">Selecione o arquivo Excel</label>
                        <input class="form-control" type="file" id="arquivo" name="file" accept=".xlsx,.xls" required>
                        <div class="form-text mt-2">
                            <strong>Formato esperado:</strong> Colunas: Dia, Identificação, Usuário, Curso/Departamento, Refeição, Comparecimento
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill"></i> 
                        O sistema identifica automaticamente se é presença ou falta pelo campo "Comparecimento" (Sim/Não).
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="importarArquivo()">
                    <i class="bi bi-upload"></i> Importar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Alunos Bloqueados -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lock-fill"></i> Alunos Bloqueados</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Matrícula</th>
                                <th>Nome</th>
                                <th>Curso</th>
                                <th class="text-center">Total Faltas</th>
                                <th class="text-end">Débito</th>
                            </tr>
                        </thead>
                        <tbody id="bloqueados-body">
                            <tr>
                                <td colspan="5" class="text-center">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log('Dashboard carregado!');
    carregarEstatisticas();
    carregarBloqueados();
    
    setInterval(() => {
        carregarEstatisticas();
        carregarBloqueados();
    }, 30000);
});

function abrirModalImportar() {
    $('#modalImportar').modal('show');
}

function importarArquivo() {
    const formData = new FormData($('#formImportar')[0]);
    const arquivo = $('#arquivo').val();
    
    if (!arquivo) {
        mostrarAlerta('warning', 'Selecione um arquivo!');
        return;
    }
    
    $.ajax({
        url: '/api/importar/agendamentos',  // URL FIXA - não usa mais ${tipo}
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            $('#modalImportar').modal('hide');
            mostrarAlerta('success', response.message);
            $('#formImportar')[0].reset();
            carregarEstatisticas();
            carregarBloqueados();
        },
        error: function(xhr) {
            const erro = xhr.responseJSON?.message || 'Erro ao importar arquivo';
            mostrarAlerta('danger', erro);
        }
    });
}

function carregarEstatisticas() {
    $.ajax({
        url: '/api/estatisticas',
        type: 'GET',
        success: function(data) {
            console.log('Estatísticas:', data);
            $('#stat-total-alunos').text(data.total_alunos || 0);
            $('#stat-bloqueados').text(data.bloqueados || 0);
            $('#stat-em-risco').text(data.em_risco || 0);
            $('#stat-debitos').text('R$ ' + (data.total_debitos || 0).toFixed(2).replace('.', ','));
        },
        error: function() {
            $('#stat-total-alunos').text('0');
            $('#stat-bloqueados').text('0');
            $('#stat-em-risco').text('0');
            $('#stat-debitos').text('R$ 0,00');
        }
    });
}

function carregarBloqueados() {
    $.ajax({
        url: '/api/relatorios/bloqueados',
        type: 'GET',
        success: function(data) {
            console.log('Bloqueados:', data);
            const tbody = $('#bloqueados-body');
            tbody.empty();
            
            if (data.length === 0) {
                tbody.append('<tr><td colspan="5" class="text-center">Nenhum aluno bloqueado</td></tr>');
                return;
            }
            
            data.forEach(function(aluno) {
                tbody.append(`
                    <tr>
                        <td>${aluno.matricula}</td>
                        <td>${aluno.nome}</td>
                        <td>${aluno.curso || '-'}</td>
                        <td class="text-center">${aluno.total_faltas || 0}</td>
                        <td class="text-end">${formatarMoeda(aluno.debito || 0)}</td>
                    </tr>
                `);
            });
        },
        error: function() {
            $('#bloqueados-body').html('<tr><td colspan="5" class="text-center text-danger">Erro ao carregar dados</td></tr>');
        }
    });
}

function formatarMoeda(valor) {
    return 'R$ ' + parseFloat(valor || 0).toFixed(2).replace('.', ',');
}

function mostrarAlerta(tipo, mensagem) {
    const alertDiv = `
        <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
            ${mensagem}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('#alert-container').html(alertDiv);
    
    setTimeout(() => {
        $('.alert').alert('close');
    }, 5000);
}
</script>
{% endblock %}